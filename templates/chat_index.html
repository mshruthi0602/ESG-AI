<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ESG-AI Chatbot Advisor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="{{ url_for('favicon') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>
    :root { --bg:#f3f4f6; --panel:#fff; --text:#111; --muted:#6b7280;
            --green:#16a34a; --yellow:#ca8a04; --red:#dc2626; --border:#e5e7eb; }

    body { background:var(--bg); font-family:system-ui,sans-serif; color:var(--text); }
    .container { max-width:820px; margin:48px auto; padding:0 16px; }
    h1 { text-align:center; margin-bottom:8px; }
    .hint { text-align:center; color:var(--muted); margin-bottom:16px; }

    .chat-box { height:420px; overflow-y:auto; border:1px solid var(--border);
                border-radius:8px; padding:12px; background:#fafafa; margin-bottom:12px; }
    .chat-message { margin:10px 0; padding:8px 12px; border-radius:8px; max-width:80%; }
    .chat-message.user { background:#2563eb; color:white; margin-left:auto; text-align:right; }
    .chat-message.bot { background:#fff; border:1px solid var(--border); text-align:left; }
    .chat-message.ai { background:#f0f9ff; border:1px solid #38bdf8; }

    form#chat-form { display:flex; gap:8px; }
    #message { flex:1; padding:10px; border:1px solid var(--border); border-radius:8px; }
    button.send { padding:10px 16px; border:none; border-radius:8px; background:#2563eb; color:#fff; cursor:pointer; }
    button.send[disabled] { opacity:.6; cursor:not-allowed; }

    table { width:100%; border-collapse:collapse; margin-top:8px; font-size:14px; }
    th,td { border:1px solid var(--border); padding:6px 8px; text-align:left; }
    th { background:#f1f5f9; }

    .green { background:#dcfce7; }
    .yellow { background:#fef9c3; }
    .red { background:#fee2e2; }

    .loading { color:var(--muted); font-style:italic; margin:6px 0; }
    .actions { margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }
    .actions button { padding:8px 12px; border-radius:6px; cursor:pointer; border:1px solid var(--border); }
    .download-btn { background:#0f766e; color:#fff; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üí¨ ESG-AI Chatbot Advisor</h1>
    <p class="hint">Ask me something like: <i>‚Äúmedium esg medium risk in tech‚Äù</i> or <i>‚Äúwhat‚Äôs the best ESG portfolio?‚Äù</i></p>

    <div id="chat-box" class="chat-box"></div>

    <form id="chat-form">
      <input id="message" type="text" placeholder="Type your request..." autocomplete="off" />
      <button class="send" id="send-btn" type="submit">Send</button>
    </form>

    <form action="/download_report" method="post" id="download-form" style="display:none;">
      <input type="hidden" name="portfolio_json" id="portfolio_json">
      <input type="hidden" name="explanation" id="report_explanation">
      <input type="hidden" name="esg_preference" id="report_esg">
      <input type="hidden" name="risk_tolerance" id="report_risk">
      <input type="hidden" name="industry" id="report_industry">
      <button type="submit" class="download-btn">üì• Download ESG Report</button>
    </form>
  </div>

  <script>
    const chatBox = document.getElementById("chat-box");
    const form = document.getElementById("chat-form");
    const input = document.getElementById("message");
    const sendBtn = document.getElementById("send-btn");

    const dlForm = document.getElementById("download-form");
    const fPortfolio = document.getElementById("portfolio_json");
    const fExpl = document.getElementById("report_explanation");
    const fESG = document.getElementById("report_esg");
    const fRisk = document.getElementById("report_risk");
    const fInd = document.getElementById("report_industry");

    let busy = false;
    let currentPortfolio = [];

    const funFacts = [
      "üìä Diversify your portfolio to reduce risk.",
      "üí° ESG = Environmental, Social, Governance.",
      "‚öñÔ∏è High volatility = higher risk.",
      "üåç Sustainable companies often outperform long-term.",
      "üìà Sentiment can shift market prices quickly."
    ];

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (busy) return;

      const message = (input.value || "").trim();
      if (!message) return;

      appendMessage("user", escapeHtml(message));
      input.value = "";
      setLoading(true);

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message })
        });
        const data = await res.json();
        currentPortfolio = data.portfolio || [];

        if (!currentPortfolio.length || currentPortfolio[0].Ticker === "No suitable match") {
          appendMessage("ai", `<b>AI Reply:</b><br>${data.reply}`);
        } else {
          appendMessage("bot", formatBotReply(data.reply, currentPortfolio, data.step));
        }

        // Save hidden inputs for report
        fExpl.value = data.explanation || "";
        fESG.value = data.esg_preference || "";
        fRisk.value = data.risk_tolerance || "";
        fInd.value = data.industry || "";

      } catch (err) {
        appendMessage("bot", `<span class="red">‚ùå Error: ${escapeHtml(String(err))}</span>`);
      } finally {
        setLoading(false);
      }
    });

    function setLoading(isLoading) {
      busy = isLoading;
      sendBtn.disabled = isLoading;
      if (isLoading) {
        let i = 0;
        const msg = document.createElement("div");
        msg.classList.add("chat-message","bot","loading");
        msg.id = "loading-msg";
        msg.textContent = funFacts[i];
        chatBox.appendChild(msg);
        chatBox.scrollTop = chatBox.scrollHeight;
        const interval = setInterval(() => {
          if (!busy) { clearInterval(interval); msg.remove(); }
          else { i = (i+1) % funFacts.length; msg.textContent = funFacts[i]; }
        }, 2500);
      }
    }

    function appendMessage(sender, html) {
      const msg = document.createElement("div");
      msg.classList.add("chat-message", sender);
      msg.innerHTML = html;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function escapeHtml(str) {
      return str.replace(/[&<>'"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;',"'":'&#39;','"':'&quot;'}[c]));
    }

    function formatBotReply(message, portfolio, step) {
      let html = `<p>${message}</p>`;
      if (Array.isArray(portfolio) && portfolio.length && portfolio[0].Ticker !== "No suitable match") {
        html += `<form id="select-form"><table><thead>
          <tr><th></th><th>Ticker</th><th>ESG Score</th><th>Risk (Vol)</th><th>Sentiment</th></tr>
        </thead><tbody>`;

        portfolio.forEach((s, i) => {
          const tier = (s.Tier || "").toLowerCase();
          const cls = tier === "green" ? "green" : tier === "yellow" ? "yellow" : "red";
          html += `<tr class="${cls}">
            <td><input type="checkbox" name="pick" value="${i}"></td>
            <td>${s.Ticker}</td>
            <td>${s.ESG_Score || "-"} (${s.ESG_Category || "-"})</td>
            <td>${s.Volatility ? Number(s.Volatility).toFixed(3) : "-"} (${s.Risk_Category || "-"})</td>
            <td>${s.Sentiment || "-"}</td>
          </tr>`;
        });
        html += `</tbody></table><div class="actions">
          <button type="button" onclick="submitSelection()">Confirm Selection (1‚Äì3)</button>
          <button type="button" onclick="restartChat()">üîÑ Restart</button>
        </div></form>`;
      }
      return html;
    }

    function submitSelection() {
      const checks = Array.from(document.querySelectorAll("#select-form input[name='pick']:checked"));
      if (checks.length === 0 || checks.length > 3) {
        alert("Please pick between 1 and 3 options.");
        return;
      }
      const chosen = checks.map(c => currentPortfolio[c.value]);
      fPortfolio.value = JSON.stringify(chosen);
      dlForm.style.display = "block";
      appendMessage("bot", "‚úÖ Great choice! You can now download your report below.");
    }

    function restartChat() {
      appendMessage("bot", "üîÑ Restarting. Please enter new ESG/Risk preferences.");
      dlForm.style.display = "none";
      currentPortfolio = [];
      fPortfolio.value = "";
      // remove old tables
      const forms = document.querySelectorAll("#select-form");
      forms.forEach(f => f.remove());
    }
  </script>
</body>
</html>
